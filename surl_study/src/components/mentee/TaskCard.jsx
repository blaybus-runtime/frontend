import { useState } from "react";
import { useAuth } from "../../context/AuthContext";
import { updateTaskStatus } from "../../api/task";

export default function TaskCard({ task, onStatusChange }) {
  const [done, setDone] = useState(task.done);
  const [loading, setLoading] = useState(false);
  const { token, user } = useAuth();

  const handleToggle = async () => {
    if (loading) return;
    setLoading(true);

    const newStatus = !done;

    try {
      await updateTaskStatus(token, task.id, user.userId, newStatus);
      setDone(newStatus);
      onStatusChange?.(task.id, newStatus);
    } catch (err) {
      console.error("상태 변경 실패:", err);
    } finally {
      setLoading(false);
    }
  };

  const statusText = done ? "완료" : task.status || "진행 중";

  return (
    <div className="w-full rounded-xl border border-gray-200 bg-white px-5 py-4">
      <div className="flex items-start justify-between gap-4">
        {/* Left */}
        <div className="min-w-0">
          <span
            className={`inline-flex items-center rounded-md px-2 py-1 text-xs font-semibold ${task.tagColor}`}
          >
            {task.tag}
          </span>

          <div className="mt-2 truncate text-sm font-semibold text-gray-900">
            {task.title}
          </div>
        </div>

        {/* Right */}
        <div className="flex flex-col items-end gap-2">
          {/* checkbox (top-right) */}
          <button
            onClick={handleToggle}
            disabled={loading}
            className={`flex h-6.5 w-6.5 items-center justify-center rounded-md border cursor-pointer transition-colors ${
              done
                ? "border-indigo-200 !bg-[#8CA3FF] text-indigo-600"
                : "border-gray-200 !bg-[#CACEDA] text-gray-300"
            } ${loading ? "opacity-50" : ""}`}
            aria-label="완료 체크"
          >
            <svg width="17" height="12" viewBox="0 0 17 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fillRule="evenodd" clipRule="evenodd" d="M15.6917 0.352908C15.9174 0.578686 16.0442 0.884866 16.0442 1.20412C16.0442 1.52337 15.9174 1.82955 15.6917 2.05532L6.66754 11.0795C6.54828 11.1988 6.4067 11.2934 6.25087 11.358C6.09504 11.4225 5.92802 11.4557 5.75934 11.4557C5.59067 11.4557 5.42365 11.4225 5.26782 11.358C5.11199 11.2934 4.9704 11.1988 4.85115 11.0795L0.367558 6.5967C0.252567 6.48564 0.160846 6.35279 0.0977467 6.2059C0.0346477 6.05901 0.00143462 5.90102 4.54579e-05 5.74116C-0.0013437 5.5813 0.0291189 5.42276 0.0896557 5.2748C0.150192 5.12683 0.239591 4.99241 0.352635 4.87936C0.465679 4.76632 0.600105 4.67692 0.748069 4.61639C0.896032 4.55585 1.05457 4.52539 1.21443 4.52677C1.3743 4.52816 1.53228 4.56138 1.67917 4.62448C1.82606 4.68758 1.95891 4.7793 2.06997 4.89429L5.75894 8.58326L13.9885 0.352908C14.1003 0.241027 14.2331 0.152274 14.3792 0.0917206C14.5253 0.0311671 14.6819 0 14.8401 0C14.9983 0 15.1549 0.0311671 15.301 0.0917206C15.4471 0.152274 15.5799 0.241027 15.6917 0.352908Z" fill="#EBF8FF"/>
            </svg>
          </button>

          {/* status (bottom-right) */}
          <div className={`inline-flex items-center gap-1.5 text-xs font-semibold ${
            done
                ? "!text-[#8CA3FF]"
                : "!text-[#CACEDA]"
          }`}>
            <span aria-hidden>
              <svg width="18" height="16" viewBox="0 0 18 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15.583 0.5V0V0.5ZM16.6367 0.609375L16.8638 0.16389L16.8637 0.163872L16.6367 0.609375ZM17.0742 1.0459L17.5197 0.818951L17.5197 0.818903L17.0742 1.0459ZM17.1826 2.09961H17.6826H17.1826ZM17.0742 12.1885L17.5197 12.4156L17.5197 12.4155L17.0742 12.1885ZM16.6367 12.625L16.8637 13.0705L16.8637 13.0705L16.6367 12.625ZM15.583 12.7344V13.2344V12.7344ZM3.74512 12.7344V12.2344C3.5493 12.2344 3.3715 12.3487 3.29022 12.5268L3.74512 12.7344ZM3.54395 13.0273L3.89737 13.381L3.8975 13.3809L3.54395 13.0273ZM2.20703 14.3633L1.85361 14.0096L1.85348 14.0097L2.20703 14.3633ZM0.5 2.09961H0H0.5ZM0.609375 1.0459L0.163933 0.818782L0.163872 0.818903L0.609375 1.0459ZM1.0459 0.609375L0.818903 0.163872L0.818782 0.163934L1.0459 0.609375ZM2.09961 0.5V0V0.5ZM15.583 0.5V1C15.871 1 16.0571 1.00049 16.1986 1.01213C16.3343 1.0233 16.3848 1.04217 16.4097 1.05488L16.6367 0.609375L16.8637 0.163872C16.6748 0.0675948 16.4784 0.0317804 16.2806 0.0155044C16.0887 -0.000291586 15.8549 0 15.583 0V0.5ZM16.6367 0.609375L16.4097 1.05486C16.5048 1.10335 16.5813 1.17989 16.6287 1.27289L17.0742 1.0459L17.5197 0.818903C17.3754 0.535628 17.1449 0.307156 16.8638 0.16389L16.6367 0.609375ZM17.0742 1.0459L16.6287 1.27285C16.6411 1.29725 16.6599 1.34736 16.6709 1.48335C16.6824 1.62517 16.6826 1.81124 16.6826 2.09961H17.1826H17.6826C17.6826 1.82824 17.6831 1.59438 17.6676 1.40275C17.6517 1.20528 17.6163 1.0084 17.5197 0.818951L17.0742 1.0459ZM17.1826 2.09961H16.6826V11.1338H17.1826H17.6826V2.09961H17.1826ZM17.1826 11.1338H16.6826C16.6826 11.4223 16.6824 11.6086 16.6709 11.7507C16.6599 11.887 16.6411 11.9372 16.6287 11.9615L17.0742 12.1885L17.5197 12.4155C17.6163 12.2259 17.6517 12.0287 17.6677 11.8312C17.6832 11.6394 17.6826 11.4053 17.6826 11.1338H17.1826ZM17.0742 12.1885L16.6288 11.9614C16.5813 12.0545 16.5047 12.1311 16.4097 12.1795L16.6367 12.625L16.8637 13.0705C17.1449 12.9272 17.3754 12.6986 17.5197 12.4156L17.0742 12.1885ZM16.6367 12.625L16.4098 12.1795C16.3848 12.1922 16.3343 12.2111 16.1986 12.2222C16.0571 12.2339 15.871 12.2344 15.583 12.2344V12.7344V13.2344C15.8549 13.2344 16.0887 13.2347 16.2806 13.2189C16.4784 13.2026 16.6747 13.1668 16.8637 13.0705L16.6367 12.625ZM15.583 12.7344V12.2344H3.74512V12.7344V13.2344H15.583V12.7344ZM3.74512 12.7344L3.29022 12.5268C3.26351 12.5854 3.22956 12.6346 3.19039 12.6738L3.54395 13.0273L3.8975 13.3809C4.02889 13.2495 4.1285 13.0987 4.20001 12.9419L3.74512 12.7344ZM3.54395 13.0273L3.19052 12.6737L1.85361 14.0096L2.20703 14.3633L2.56046 14.717L3.89737 13.381L3.54395 13.0273ZM2.20703 14.3633L1.85348 14.0097C1.53846 14.3247 1 14.1017 1 13.6562H0.5H0C0 14.9927 1.61567 15.6617 2.56058 14.7168L2.20703 14.3633ZM0.5 13.6562H1V2.09961H0.5H0V13.6562H0.5ZM0.5 2.09961H1C1 1.81166 1.00049 1.62556 1.01214 1.48405C1.02331 1.34833 1.04219 1.29779 1.05488 1.27289L0.609375 1.0459L0.163872 0.818903C0.0675915 1.00786 0.0317845 1.20429 0.0155096 1.40201C-0.000287831 1.59394 0 1.82777 0 2.09961H0.5ZM0.609375 1.0459L1.05482 1.27301C1.10274 1.17903 1.17903 1.10274 1.27301 1.05482L1.0459 0.609375L0.818782 0.163934C0.536827 0.307694 0.307694 0.536827 0.163934 0.818782L0.609375 1.0459ZM1.0459 0.609375L1.27289 1.05488C1.29779 1.04219 1.34833 1.02331 1.48405 1.01214C1.62556 1.00049 1.81166 1 2.09961 1V0.5V0C1.82777 0 1.59394 -0.000287831 1.40201 0.0155096C1.20429 0.0317844 1.00786 0.0675914 0.818903 0.163872L1.0459 0.609375ZM2.09961 0.5V1H15.583V0.5V0H2.09961V0.5Z" fill="currentColor"/>
              <path d="M4.84131 4.5L12.8413 4.5" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round"/>
              <path d="M4.84131 8.5L10.8413 8.5" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round"/>
              </svg>
            </span>
            <span>{statusText}</span>
          </div>
        </div>
      </div>
    </div>
  );
}
